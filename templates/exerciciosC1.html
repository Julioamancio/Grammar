<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Exercícios Interativos – Nível C1</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    .c1-ex-container {
      background: #fff;
      border-radius: 18px;
      max-width: 940px;
      margin: 26px auto 30px auto;
      box-shadow: 0 4px 32px #8e24aa15;
      padding: 32px 34px 25px 34px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .c1-title {
      font-size: 1.4em;
      color: #8e24aa;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      margin-top: 0;
      justify-content: flex-start;
    }
    .c1-medals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 13px 18px;
      margin-bottom: 20px;
      align-items: center;
    }
    .c1-medal-item {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 1em;
      background: #f5f5f5;
      border-radius: 7px;
      padding: 5px 13px;
      min-width: 90px;
      border: 1px solid #e3e3e3;
      justify-content: center;
    }
    .c1-medal {
      font-size: 1.3em;
      padding-right: 2px;
      vertical-align: middle;
    }
    .c1-medal-gold { color: #ffb300; }
    .c1-medal-silver { color: #90caf9; }
    .c1-medal-bronze { color: #bcaaa4; }
    .c1-topic-title {
      font-size: 1.13em;
      color: #8e24aa;
      font-weight: bold;
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .c1-question {
      font-size: 1.09em;
      margin-bottom: 13px;
      color: #1a237e;
    }
    .c1-options label {
      display: block;
      margin-bottom: 9px;
      background: #ede7f6;
      border-radius: 6px;
      padding: 9px 13px;
      cursor: pointer;
      transition: background 0.18s;
      font-size: 1.09em;
      border: 1px solid #d1c4e9;
    }
    .c1-options input[type="radio"] {
      margin-right: 8px;
    }
    .c1-options label.correct {
      background: #dcedc8;
      font-weight: 600;
    }
    .c1-options label.incorrect {
      background: #ffcdd2;
      font-weight: 600;
    }
    .c1-options input[disabled] + span,
    .c1-options input[disabled] {
      cursor: not-allowed;
    }
    .c1-feedback {
      margin-top: 7px;
      font-weight: bold;
      min-height: 18px;
    }
    .c1-explanation {
      margin-top: 5px;
      font-size: 0.98em;
      color: #1a237e;
      background: #e7f7e7;
      border-radius: 5px;
      padding: 6px 12px;
      margin-bottom: 5px;
      display: inline-block;
    }
    .c1-next-btn {
      background: #8e24aa;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 22px;
      font-size: 1.06em;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.18s;
      display: none;
    }
    .c1-next-btn.active {
      display: inline-block;
    }
    .c1-progress {
      margin-top: 15px;
      color: #888;
      font-size: 0.98em;
    }
    @media (max-width: 1100px) {
      .c1-ex-container { max-width: 99vw; padding: 3vw 1vw; }
    }
    @media (max-width: 700px) {
      .c1-title { font-size: 1.1em; margin-top: 8px; }
      .c1-medals-row { flex-direction: column; gap: 7px; }
      .c1-medal-item { min-width: 0; width: 100%; }
      .c1-ex-container { padding: 2vw 2vw; }
    }
    .c1-end-message {
      text-align: center;
      padding: 25px 0;
      max-width: 540px;
      margin: 0 auto;
      background: #ede7f6;
      border-radius: 10px;
      box-shadow: 0 3px 12px #8e24aa30;
      margin-top: 24px;
    }
    .c1-navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .c1-back-button {
      text-decoration: none;
      color: #8e24aa;
      display: flex;
      align-items: center;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="c1-ex-container">
  <div class="c1-navbar"></div>
  <div class="c1-title">
    <i class="fa-solid fa-arrow-up-right-dots"></i>
    Exercícios Interativos – Nível C1
  </div>
  <div id="c1-medals"></div>
  <div id="c1-root"></div>
</div>
<script src="/static/js/medalhas.js"></script>
<script>
// ====== QUESTÕES C1 COM EXPLICAÇÃO EMBUTIDA PROFISSIONAL ======
const c1Topics = [
  {
    icon: "fa-exchange-alt", color: "#8e24aa", title: "Inversion with conditionals", questions: [
      { q: "___ I known about the meeting, I would have attended.", a: ["Had", "If", "Have"], correct: 0, explicacao: "Had: Correto. Inversão condicional: 'Had I known' equivale a 'If I had known'." },
      { q: "___ you need any help, let me know.", a: ["Should", "If", "Would"], correct: 0, explicacao: "Should: Correto. Inversão condicional: 'Should you need' = 'If you need'." }
    ]
  },
  {
    icon: "fa-random", color: "#6d4c41", title: "Mixed tenses in context", questions: [
      { q: "By the time she ___ (arrive), we ___ (already/leave).", a: ["arrived / had already left", "arrives / have already left", "was arriving / already left"], correct: 0, explicacao: "arrived / had already left: Correto. Sequência passada: passado simples seguido de past perfect." },
      { q: "He ___ (live) in London before he ___ (move) to Paris.", a: ["had lived / moved", "lived / had moved", "has lived / moves"], correct: 0, explicacao: "had lived / moved: Correto. Past perfect para o que veio antes." }
    ]
  },
  {
    icon: "fa-bullhorn", color: "#3949ab", title: "Emphatic structures", questions: [
      { q: "___ I need is a good night's sleep.", a: ["What", "That", "Which"], correct: 0, explicacao: "What: Correto. Estrutura enfática 'What I need...'" },
      { q: "The thing ___ annoys me is the noise.", a: ["that", "who", "what"], correct: 0, explicacao: "that: Correto. 'That' para definir coisas." }
    ]
  },
  {
    icon: "fa-pen-fancy", color: "#26a69a", title: "Nominalisation", questions: [
      { q: "___ of the report was time-consuming.", a: ["The writing", "To write", "Writing"], correct: 0, explicacao: "The writing: Correto. Nominalização com 'the + -ing'." },
      { q: "___ is important for improvement.", a: ["Revision", "Revise", "Revising"], correct: 0, explicacao: "Revision: Correto. Substantivo para 'revisar'." }
    ]
  },
  {
    icon: "fa-project-diagram", color: "#43a047", title: "Discourse markers", questions: [
      { q: "He was tired. ___, he kept working.", a: ["Nevertheless", "Because", "Therefore"], correct: 0, explicacao: "Nevertheless: Correto. Contraste entre frases." },
      { q: "She didn’t like the food. ___, she ate everything.", a: ["However", "Although", "Moreover"], correct: 0, explicacao: "However: Correto. Contraste/adversidade." }
    ]
  },
  {
    icon: "fa-code-branch", color: "#7e57c2", title: "Advanced linkers", questions: [
      { q: "Not only is he smart, ___ he is also very funny.", a: ["but also", "and", "or"], correct: 0, explicacao: "but also: Correto. Estrutura 'not only... but also...'." },
      { q: "You can borrow my car ___ you drive carefully.", a: ["as long as", "even though", "unless"], correct: 0, explicacao: "as long as: Correto. Condição positiva." }
    ]
  },
  {
    icon: "fa-brain", color: "#fbc02d", title: "Idiomatic expressions", questions: [
      { q: "That test was ___; I finished it in 10 minutes.", a: ["a piece of cake", "to break the ice", "under the weather"], correct: 0, explicacao: "a piece of cake: Correto. Expressão para 'muito fácil'." },
      { q: "He told a joke to ___ at the meeting.", a: ["break the ice", "spill the beans", "hit the sack"], correct: 0, explicacao: "break the ice: Correto. Tornar o ambiente mais descontraído." }
    ]
  },
  {
    icon: "fa-gavel", color: "#e65100", title: "Subjunctive", questions: [
      { q: "If I ___ you, I would talk to her.", a: ["were", "was", "am"], correct: 0, explicacao: "were: Correto. Subjuntivo após 'If I...'" },
      { q: "It's essential that he ___ present.", a: ["be", "is", "was"], correct: 0, explicacao: "be: Correto. Subjuntivo após 'It's essential that...'" }
    ]
  },
  {
    icon: "fa-balance-scale", color: "#009688", title: "Formal vs. informal structures", questions: [
      { q: "___ you require assistance, please contact us. (formal)", a: ["Should", "If", "Would"], correct: 0, explicacao: "Should: Correto. Estrutura formal: 'Should you...'" },
      { q: "___ you want to come, just let me know. (informal)", a: ["If", "Should", "Would"], correct: 0, explicacao: "If: Correto. Estrutura informal." }
    ]
  },
  {
    icon: "fa-history", color: "#cddc39", title: "Modality in past", questions: [
      { q: "You ___ (do) that; it was dangerous.", a: ["shouldn't have done", "ought not have done", "might not have done"], correct: 0, explicacao: "shouldn't have done: Correto. Modalidade passada para reprovação." },
      { q: "She ___ (tell) the truth, but she didn't.", a: ["ought to have told", "should have tell", "should have tells"], correct: 0, explicacao: "ought to have told: Correto. Modalidade para obrigação não cumprida." }
    ]
  },
  {
    icon: "fa-quote-right", color: "#ff7043", title: "Advanced reported speech", questions: [
      { q: "He said, 'I will call you tomorrow.' → He said that he ___ call me the next day.", a: ["would", "will", "can"], correct: 0, explicacao: "would: Correto. will → would no reported speech." },
      { q: "She said, 'I saw him yesterday.' → She said she ___ him the day before.", a: ["had seen", "has seen", "saw"], correct: 0, explicacao: "had seen: Correto. saw → had seen no reported speech." }
    ]
  },
  {
    icon: "fa-hand-holding-heart", color: "#8d6e63", title: "Hedging and softening language", questions: [
      { q: "___, the situation seems to be improving.", a: ["Apparently", "Obviously", "Certainly"], correct: 0, explicacao: "Apparently: Correto. Expressa incerteza/hedge." },
      { q: "It ___ that the results are positive.", a: ["seems", "shows", "proves"], correct: 0, explicacao: "seems: Correto. 'It seems that...' é linguagem suavizadora." }
    ]
  },
  {
    icon: "fa-user-edit", color: "#5d4037", title: "Reduced relative clauses", questions: [
      { q: "The man ___ to her is my uncle.", a: ["talking", "who talks", "talks"], correct: 0, explicacao: "talking: Correto. Reduced relative clause ('who is talking' → 'talking')." },
      { q: "The books ___ on the table are mine.", a: ["lying", "which lie", "lies"], correct: 0, explicacao: "lying: Correto. Reduced relative clause ('which are lying' → 'lying')." }
    ]
  },
  {
    icon: "fa-user-shield", color: "#607d8b", title: "Complex passive structures", questions: [
      { q: "He is ___ to have committed the crime.", a: ["said", "told", "say"], correct: 0, explicacao: "said: Correto. Estrutura passiva: 'is said to have...'" },
      { q: "The project ___ to be completed by next month.", a: ["is expected", "expects", "expected"], correct: 0, explicacao: "is expected: Correto. Passiva complexa." }
    ]
  },
  {
    icon: "fa-random", color: "#00bcd4", title: "Advanced conditionals", questions: [
      { q: "___ you study hard, you will not pass.", a: ["Unless", "If", "Provided that"], correct: 0, explicacao: "Unless: Correto. 'Unless' para 'a não ser que'." },
      { q: "You can go out ___ you finish your homework.", a: ["provided that", "unless", "as if"], correct: 0, explicacao: "provided that: Correto. Condição positiva." }
    ]
  }
];

const medalTypes = [
  { name: "Ouro", icon: "fa-medal", class: "c1-medal-gold", emoji: "🥇" },
  { name: "Prata", icon: "fa-medal", class: "c1-medal-silver", emoji: "🥈" },
  { name: "Bronze", icon: "c1-medal-bronze", emoji: "🥉" }
];
const medalByAttempts = (n) => n === 1 ? 0 : n === 2 ? 1 : 2;
let currentTopic = 0, currentQ = 0;
let questoesTentativas = [];
let totalQuestoes = 0;

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
function embaralharTudo() {
  shuffle(c1Topics);
  c1Topics.forEach(topic => {
    shuffle(topic.questions);
    topic.questions.forEach(q => {
      const correctAnswer = q.a[q.correct];
      shuffle(q.a);
      q.correct = q.a.indexOf(correctAnswer);
    });
  });
}
function inicializaQuestoes() {
  embaralharTudo();
  questoesTentativas = [];
  c1Topics.forEach(topic => {
    topic.questions.forEach(() => {
      questoesTentativas.push({ tentativas: 0, medalha: null, answered: false });
    });
  });
  totalQuestoes = questoesTentativas.length;
}
function getQuestaoIdx(topicIdx, qIdx) {
  let idx = 0;
  for (let t = 0; t < topicIdx; t++) {
    idx += c1Topics[t].questions.length;
  }
  return idx + qIdx;
}
function renderC1Exercise() {
  renderMedalsStatus();
  const t = c1Topics[currentTopic];
  const q = t.questions[currentQ];
  const qidx = getQuestaoIdx(currentTopic, currentQ);
  const medalObj = questoesTentativas[qidx];
  let html = `
    <div>
      <div class="c1-topic-title">
        <i class="fa-solid ${t.icon}" style="color:${t.color}"></i> ${t.title}
      </div>
      <div class="c1-question">${q.q}</div>
      <form class="c1-options" id="c1-options">
        ${q.a.map((opt, i) => `
          <label>
            <input type="radio" name="c1" value="${i}" ${medalObj.answered ? "disabled" : ""}> ${opt}
          </label>
        `).join('')}
      </form>
      <div class="c1-feedback" id="c1-feedback"></div>
      <button class="c1-next-btn" id="c1-next-btn" style="display:none;">Próxima</button>
      <div class="c1-progress">
        Progresso: <b>${getC1Progress()}</b>
      </div>
    </div>
  `;
  document.getElementById('c1-root').innerHTML = html;
  if (medalObj.answered) {
    showGabarito(medalObj, t, q, qidx);
  }
  document.getElementById('c1-options').onclick = function(e) {
    if (e.target.name === "c1" && !medalObj.answered) {
      checkC1(e.target.value);
    }
  };
  document.getElementById('c1-next-btn').onclick = nextC1;
}
function checkC1(val) {
  val = +val;
  const t = c1Topics[currentTopic];
  const q = t.questions[currentQ];
  const qidx = getQuestaoIdx(currentTopic, currentQ);
  const medalObj = questoesTentativas[qidx];
  medalObj.tentativas++;
  const radios = document.querySelectorAll('.c1-options input[type="radio"]');
  if (val === q.correct) {
    medalObj.answered = true;
    medalObj.medalha = medalByAttempts(medalObj.tentativas);
    showGabarito(medalObj, t, q, qidx);
    renderMedalsStatus();
    if (typeof premiarMedalha === "function") {
      premiarMedalha("C1", qidx + 1, medalTypes[medalObj.medalha].name.toLowerCase());
    }
  } else {
    radios.forEach(inp => inp.checked = false);
    const labels = document.querySelectorAll('.c1-options label');
    labels.forEach((label, i) => {
      label.classList.remove('correct', 'incorrect');
      if (i === val) label.classList.add('incorrect');
    });
    document.getElementById('c1-feedback').innerHTML =
      `<span style="color:#e53935;"><i class="fa-solid fa-circle-xmark"></i> Errou!</span>
       <div class="c1-explanation">${q.explicacao}</div>`;
  }
}
function showGabarito(medalObj, t, q, qidx) {
  const labels = document.querySelectorAll('.c1-options label');
  labels.forEach((label, i) => {
    label.classList.remove('correct', 'incorrect');
    if (i === q.correct) label.classList.add('correct');
  });
  document.querySelectorAll('.c1-options input[type="radio"]').forEach(inp => inp.disabled = true);
  const fb = document.getElementById('c1-feedback');
  let medalTxt = '';
  if (medalObj.medalha !== null) {
    if (medalObj.medalha === 0)
      medalTxt = `🥇 <b>Ouro conquistada!</b>`;
    else if (medalObj.medalha === 1)
      medalTxt = `🥈 <b>Prata conquistada!</b>`;
    else
      medalTxt = `🥉 <b>Bronze conquistada!</b>`;
  }
  fb.innerHTML = `<span style="color:#43a047;"><i class="fa-solid fa-circle-check"></i> Correto!</span> ${medalTxt}
    <div class="c1-explanation">${q.explicacao}</div>`;
  document.getElementById('c1-next-btn').style.display = "inline-block";
}
function nextC1() {
  const t = c1Topics[currentTopic];
  if (currentQ < t.questions.length - 1) {
    currentQ++;
  } else if (currentTopic < c1Topics.length - 1) {
    currentTopic++;
    currentQ = 0;
  } else {
    showC1Result();
    return;
  }
  renderC1Exercise();
}
function getC1Progress() {
  let done = questoesTentativas.filter(q => q.answered).length;
  return `${done}/${totalQuestoes}`;
}
function showC1Result() {
  let ouro = questoesTentativas.filter(q => q.answered && q.medalha === 0).length;
  let percent = Math.round((ouro / totalQuestoes) * 100);
  let color = percent >= 60 ? "#43a047" : "#e53935";
  let msg = percent >= 60
    ? `<i class="fa-solid fa-crown"></i> Parabéns! Você concluiu o nível C1 com <b>${percent}%</b> de OURO (acertos de primeira tentativa).<br><br>
       O próximo nível está liberado, e você receberá um certificado no seu e-mail!`
    : `<i class="fa-solid fa-circle-xmark"></i> Você concluiu com <b>${percent}%</b> de OURO (acertos de primeira tentativa).<br><br>
       Você precisa repetir o nível para liberar o próximo.`;
  document.getElementById('c1-root').innerHTML = `
    <div class="c1-end-message" style="color:${color};">
      <div style="font-size:1.18em;">
        ${msg}
      </div>
    </div>
  `;
  renderMedalsStatus(true);
  if (percent >= 60 && window.currentUserNivel !== undefined) {
    fetch("/enviar_resultado", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({nivel: "C1", resultado: percent})
    });
  }
}
function renderMedalsStatus(showAll = false) {
  let html = `<div class="c1-medals-row">`;
  let idx = 0;
  c1Topics.forEach((topic) => {
    topic.questions.forEach(() => {
      const m = questoesTentativas[idx];
      let medalStr = "";
      if (m.answered || showAll) {
        if (m.medalha !== null) {
          medalStr = medalIconHtml(m.medalha) + ` <span>${medalTypes[m.medalha].name}</span>`;
        } else {
          medalStr = `<span style="color:#aaa;">—</span>`;
        }
      }
      html += `<div class="c1-medal-item">
        <span style="font-weight:600;">${idx + 1}.</span> ${medalStr}
      </div>`;
      idx++;
    });
  });
  html += `</div>`;
  document.getElementById('c1-medals').innerHTML = html;
}
function medalIconHtml(idx) {
  if (idx === 0) return `<span class="c1-medal c1-medal-gold"><i class="fa-solid fa-medal"></i></span>`;
  if (idx === 1) return `<span class="c1-medal c1-medal-silver"><i class="fa-solid fa-medal"></i></span>`;
  return `<span class="c1-medal c1-medal-bronze"><i class="fa-solid fa-medal"></i></span>`;
}
// Inicialização profissional e segura
inicializaQuestoes();
renderC1Exercise();
</script>
</body>
</html>