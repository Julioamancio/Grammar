<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Exercícios Interativos – Nível A1</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">


  <style>
    .a1-ex-container {
      background: #fff;
      border-radius: 18px;
      max-width: 940px;
      margin: 26px auto 30px auto;
      box-shadow: 0 4px 32px #1976d215;
      padding: 32px 34px 25px 34px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .a1-title {
      font-size: 1.4em;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      margin-top: 0;
      justify-content: flex-start;
    }
    .a1-medals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 13px 18px;
      margin-bottom: 20px;
      align-items: center;
    }
    .a1-medal-item {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 1em;
      background: #f5f5f5;
      border-radius: 7px;
      padding: 5px 13px;
      min-width: 90px;
      border: 1px solid #e3e3e3;
      justify-content: center;
    }
    .a1-medal {
      font-size: 1.3em;
      padding-right: 2px;
      vertical-align: middle;
    }
    .a1-medal-gold { color: #ffb300; }
    .a1-medal-silver { color: #90caf9; }
    .a1-medal-bronze { color: #bcaaa4; }
    .a1-topic-title {
      font-size: 1.13em;
      color: #1976d2;
      font-weight: bold;
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .a1-question {
      font-size: 1.09em;
      margin-bottom: 13px;
      color: #1a237e;
    }
    .a1-options label {
      display: block;
      margin-bottom: 9px;
      background: #e3f3fd;
      border-radius: 6px;
      padding: 9px 13px;
      cursor: pointer;
      transition: background 0.18s;
      font-size: 1.09em;
      border: 1px solid #dde6fa;
    }
    .a1-options input[type="radio"] {
      margin-right: 8px;
    }
    .a1-options label.correct {
      background: #dcedc8;
      font-weight: 600;
    }
    .a1-options label.incorrect {
      background: #ffcdd2;
      font-weight: 600;
    }
    .a1-options input[disabled] + span,
    .a1-options input[disabled] {
      cursor: not-allowed;
    }
    .a1-feedback {
      margin-top: 7px;
      font-weight: bold;
      min-height: 18px;
    }
    .a1-explanation {
      margin-top: 5px;
      font-size: 0.98em;
      color: #1a237e;
      background: #e7f7e7;
      border-radius: 5px;
      padding: 6px 12px;
      margin-bottom: 5px;
      display: inline-block;
    }
    .a1-next-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 22px;
      font-size: 1.06em;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.18s;
      display: none;
    }
    .a1-next-btn.active {
      display: inline-block;
    }
    .a1-progress {
      margin-top: 15px;
      color: #888;
      font-size: 0.98em;
    }

    @media (max-width: 1100px) {
      .a1-ex-container { max-width: 99vw; padding: 3vw 1vw; }
    }
    @media (max-width: 700px) {
      .a1-title { font-size: 1.1em; margin-top: 8px; }
      .a1-medals-row { flex-direction: column; gap: 7px; }
      .a1-medal-item { min-width: 0; width: 100%; }
      .a1-ex-container { padding: 2vw 2vw; }
    }

    /* Realce do resultado final */
    .a1-end-message {
      text-align: center;
      padding: 25px 0;
      max-width: 540px;
      margin: 0 auto;
      background: #f5f5f5;
      border-radius: 10px;
      box-shadow: 0 3px 12px #1976d230;
      margin-top: 24px;
    }
  </style>
</head>
<body>
<div class="a1-ex-container">
  <div class="a1-title">
    <i class="fa-solid fa-seedling"></i>
    Exercícios Interativos – Nível A1
  </div>
  <div id="a1-medals"></div>
  <div id="a1-root"></div>
</div>

<script>
/**
 * Embaralha um array (Fisher–Yates shuffle).
 */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

const a1Topics = [
  
  {
    icon: "fa-user-check", color: "#29b6f6", title: "Verb to be", questions: [
      { q: "At school, Luiza introduces herself to her classmates.\nLuiza is a teacher. She ___ a teacher.", a: ["is", "are", "am"], correct: 0 },
      { q: "In class, Lucas is talking about how he feels today.\nLucas says: 'I ___ not tired.'", a: ["is", "are", "am"], correct: 2 },
      { q: "Anna meets her friend in the hallway and wants to know how she is.\nAnna meets her friend and asks: '___ you happy today?'", a: ["Are", "Is", "Am"], correct: 0 }
    ]
  },
  {
    icon: "fa-user", color: "#1976d2", title: "Subject pronouns", questions: [
      { q: "Maria likes music and is playing a song for the class.\nMaria likes music. ___ plays the piano.", a: ["He", "It", "She"], correct: 2 },
      { q: "Paul and I are friends who walk to school together every morning.\n___ go to school together.", a: ["We", "They", "You"], correct: 0 }
    ]
  },
  {
    icon: "fa-heart", color: "#e57373", title: "Possessive adjectives", questions: [
      { q: "John is introducing himself to the class.\nJohn introduces himself: '___ name is John.'", a: ["My", "Your", "His"], correct: 0 },
      { q: "Ana has a dog and wants to talk about it to her friends.\nAna has a dog. ___ dog is small.", a: ["Your", "Her", "His"], correct: 1 }
    ]
  },
  {
    icon: "fa-calendar-day", color: "#43a047", title: "Simple present", questions: [
      { q: "Every morning, he leaves home for school.\nHe ___ to school every day.", a: ["go", "goes", "going"], correct: 1 },
      { q: "You are having lunch with your friend and want to know about his tastes.\nDo ___ like apples?", a: ["he", "you", "she"], correct: 1 }
    ]
  },
  {
    icon: "fa-book-open", color: "#ffb300", title: "Articles: a / an / the", questions: [
      { q: "Ana tells the class about her job.\nAna is a teacher. She is ___ teacher.", a: ["an", "a", "the"], correct: 1 },
      { q: "At the zoo, you see a big animal for the first time.\nAt the zoo, I saw ___ elephant.", a: ["a", "an", "the"], correct: 1 }
    ]
  },
  {
    icon: "fa-clone", color: "#ab47bc", title: "Plural of nouns", questions: [
      { q: "At the park, you see some kids playing.\nThere are two ___ in the park.", a: ["childs", "children", "childes"], correct: 1 }
    ]
  },
  {
    icon: "fa-location-dot", color: "#26a69a", title: "There is / There are", questions: [
      { q: "You look at your classroom and notice something on the table.\nOn the table, there ___ a book.", a: ["is", "are", "am"], correct: 0 },
      { q: "You are in the garden and see some animals.\nIn the garden, there ___ two cats.", a: ["is", "are", "am"], correct: 1 }
    ]
  },
  {
    icon: "fa-map-pin", color: "#ff7043", title: "Prepositions of place", questions: [
      { q: "You are looking for your cat and describe its location.\nThe cat is ___ the box.", a: ["in", "on", "under"], correct: 0 },
      { q: "You see a book and describe where it is.\nThe book is ___ the table.", a: ["on", "in", "under"], correct: 0 }
    ]
  },
  {
    icon: "fa-hand-pointer", color: "#3949ab", title: "Demonstratives", questions: [
      { q: "You are standing next to your friend and want to introduce him.\n___ is my friend.", a: ["These", "That", "This"], correct: 2 },
      { q: "You point to some shoes far from you.\n___ are my shoes.", a: ["That", "Those", "These"], correct: 1 }
    ]
  },
  {
    icon: "fa-bolt", color: "#f4511e", title: "Imperatives", questions: [
      { q: "The classroom is hot and the teacher asks for your help.\nThe teacher says: '___ the window, please.'", a: ["Open", "Opens", "Opening"], correct: 0 }
    ]
  },
  {
    icon: "fa-question", color: "#00838f", title: "Basic question words", questions: [
      { q: "You want to meet someone and ask their name.\n___ is your name?", a: ["Where", "What", "Who"], correct: 1 },
      { q: "You are looking at a photo and want to know about a person in it.\n___ is your friend?", a: ["Who", "What", "Where"], correct: 0 }
    ]
  },
  {
    icon: "fa-gift", color: "#00c853", title: "Have got / Has got", questions: [
      { q: "Ana has a new bike and shows it to the class.\nAna has a new bike. She ___ a new bike.", a: ["have got", "has got", "got"], correct: 1 },
      { q: "Lucas is talking about his family.\nLucas says: 'I ___ two brothers.'", a: ["have got", "has got", "got"], correct: 0 }
    ]
  },
  {
    icon: "fa-s", color: "#8d6e63", title: "Possessive 's", questions: [
      { q: "You see a car that belongs to John.\nThis car belongs to John. This is ___ car.", a: ["John's", "John", "Johns"], correct: 0 }
    ]
  },
  {
    icon: "fa-person-running", color: "#00897b", title: "Can (ability and permission)", questions: [
      { q: "You are talking about your friend's abilities.\nShe ___ swim very well.", a: ["can", "can't", "cans"], correct: 0 },
      { q: "You need to leave the classroom and ask the teacher for permission.\n___ I go to the bathroom?", a: ["Can", "Cans", "Does"], correct: 0 }
    ]
  },
  {
    icon: "fa-link", color: "#afb42b", title: "Basic conjunctions", questions: [
      { q: "You are talking about your favorite fruits.\nI like apples ___ oranges.", a: ["and", "but", "or"], correct: 0 },
      { q: "You feel tired, so you decide to go to bed.\nI am tired, ___ I will go to bed.", a: ["but", "and", "so"], correct: 2 }
    ]
  }
];


const explicacoes = [
  [
    [
      "is: Correto. She → is.<br>are/am: <b>Errado.</b> Para 'she', o correto é 'is'.<br><b>Dica:</b> Para he/she/it usamos 'is'."
    ],
    [
      "am: Correto. I → am.<br>is/are: <b>Errado.</b> Para 'I', usamos 'am'."
    ],
    [
      "are: Correto. You → are.<br>is/am: <b>Errado.</b> Para 'you', usamos 'are'."
    ]
  ],
  [
    [
      "She: Correto. Maria = she (ela).<br>He: masculino.<br>It: coisas/animais."
    ],
    [
      "We: Correto. 'Me and my friend' = 'nós' (we).<br>They: eles/elas. You: você/vocês."
    ]
  ],
  [
    [
      "My: Correto. Estou falando de mim mesmo.<br>Your/His: Errado, é sobre outra pessoa."
    ],
    [
      "Her: Correto. 'Ana' = she; 'her dog'.<br>Your/His: Errado, não é 'você' ou masculino."
    ]
  ],
  [
    [
      "goes: Correto. He/She/It + verbo + s.<br>go/going: Errado, falta o 's'."
    ],
    [
      "you: Correto. Pergunta para 'você'.<br>he/she: Errado, não usamos para perguntas com 'do' para 'he/she'."
    ]
  ],
  [
    [
      "a: Correto. 'teacher' começa com som de consoante.<br>an: só para som de vogal.<br>the: artigo definido."
    ],
    [
      "an: Correto. 'elephant' começa com som de vogal.<br>a/the: Errado."
    ]
  ],
  [
    [
      "children: Correto. Plural irregular de 'child'.<br>childs/childes: Errado."
    ]
  ],
  [
    [
      "is: Correto. Book é singular.<br>are/am: Errado."
    ],
    [
      "are: Correto. Two cats é plural.<br>is/am: Errado."
    ]
  ],
  [
    [
      "in: Correto. Dentro da caixa.<br>on/under: Errado."
    ],
    [
      "on: Correto. Sobre a mesa.<br>in/under: Errado."
    ]
  ],
  [
    [
      "This: Correto. Perto e singular.<br>These/That: Errado."
    ],
    [
      "Those: Correto. Longe e plural.<br>That/These: Errado."
    ]
  ],
  [
    [
      "Open: Correto. Imperativo: verbo base.<br>Opens/Opening: Errado."
    ]
  ],
  [
    [
      "What: Correto. Para perguntar nome.<br>Where/Who: Errado."
    ],
    [
      "Who: Correto. Pessoa.<br>What/Where: Errado."
    ]
  ],
  [
    [
      "has got: Correto. She/He/It → has got.<br>have got/got: Errado."
    ],
    [
      "have got: Correto. I/You/We/They → have got.<br>has got/got: Errado."
    ]
  ],
  [
    [
      "John's: Correto. Possessivo.<br>John/Johns: Errado."
    ]
  ],
  [
    [
      "can: Correto. Habilidade.<br>can't/cans: Errado."
    ],
    [
      "Can: Correto. Pedido de permissão.<br>Cans/Does: Errado."
    ]
  ],
  [
    [
      "and: Correto. Adição.<br>but/or: Errado."
    ],
    [
      "so: Correto. Resultado/consequência.<br>but/and: Errado."
    ]
  ]
];

const medalTypes = [
  { name: "Ouro", icon: "fa-medal", class: "a1-medal-gold", emoji: "🥇" },
  { name: "Prata", icon: "fa-medal", class: "a1-medal-silver", emoji: "🥈" },
  { name: "Bronze", icon: "fa-medal-bronze", emoji: "🥉" }
];

const medalByAttempts = (n) => n === 1 ? 0 : n === 2 ? 1 : 2;

let currentTopic = 0, currentQ = 0;
let questoesTentativas = [];
let totalQuestoes = 0;

/**
 * Inicialmente, embaralha:
 * - a lista de tópicos
 * - dentro de cada tópico, a lista de questões
 * - dentro de cada questão, as opções e o índice correto
 */
function embaralharTudo() {
  // Embaralha a lista de tópicos
  shuffle(a1Topics);

  // Para cada tópico, embaralha as questões
  a1Topics.forEach(topic => {
    shuffle(topic.questions);
    topic.questions.forEach(q => {
      // Salva a resposta correta atual
      const correctAnswer = q.a[q.correct];
      // Embaralha as opções
      shuffle(q.a);
      // Redefine o índice 'correct' com base em onde a resposta correta foi parar
      q.correct = q.a.indexOf(correctAnswer);
    });
  });
}

// Inicializa tentativas para todas as questões
function inicializaQuestoes() {
  embaralharTudo();
  questoesTentativas = [];
  a1Topics.forEach(topic => {
    topic.questions.forEach(() => {
      questoesTentativas.push({ tentativas: 0, medalha: null, answered: false });
    });
  });
  totalQuestoes = questoesTentativas.length;
}

function getQuestaoIdx(topicIdx, qIdx) {
  let idx = 0;
  for (let t = 0; t < topicIdx; t++) {
    idx += a1Topics[t].questions.length;
  }
  return idx + qIdx;
}

function renderA1Exercise() {
  renderMedalsStatus();
  const t = a1Topics[currentTopic];
  const q = t.questions[currentQ];
  const qidx = getQuestaoIdx(currentTopic, currentQ);
  const medalObj = questoesTentativas[qidx];

  let html = `
    <div>
      <div class="a1-topic-title">
        <i class="fa-solid ${t.icon}" style="color:${t.color}"></i> ${t.title}
      </div>
      <div class="a1-question">${q.q}</div>
      <form class="a1-options" id="a1-options">
        ${q.a.map((opt, i) => `
          <label>
            <input type="radio" name="a1" value="${i}" ${medalObj.answered ? "disabled" : ""}> ${opt}
          </label>
        `).join('')}
      </form>
      <div class="a1-feedback" id="a1-feedback"></div>
      <button class="a1-next-btn" id="a1-next-btn" style="display:none;">Próxima</button>
      <div class="a1-progress">
        Progresso: <b>${getA1Progress()}</b>
      </div>
    </div>
  `;
  document.getElementById('a1-root').innerHTML = html;

  // Se já respondeu, marca correta, mostra botão próxima
  if (medalObj.answered) {
    showGabarito(medalObj, t, q, qidx);
  }

  document.getElementById('a1-options').onclick = function(e) {
    if (e.target.name === "a1" && !medalObj.answered) {
      checkA1(e.target.value);
    }
  };
  document.getElementById('a1-next-btn').onclick = nextA1;
}

function checkA1(val) {
  val = +val;
  const t = a1Topics[currentTopic];
  const q = t.questions[currentQ];
  const qidx = getQuestaoIdx(currentTopic, currentQ);
  const medalObj = questoesTentativas[qidx];
  medalObj.tentativas++;

  const radios = document.querySelectorAll('.a1-options input[type="radio"]');
  // Se acertou
  if (val === q.correct) {
    medalObj.answered = true;
    medalObj.medalha = medalByAttempts(medalObj.tentativas);
    showGabarito(medalObj, t, q, qidx);
    renderMedalsStatus();
  } else {
    // Mostra o erro e explicação
    radios.forEach(inp => inp.checked = false); // desmarca
    const labels = document.querySelectorAll('.a1-options label');
    labels.forEach((label, i) => {
      label.classList.remove('correct', 'incorrect');
      if (i === val) label.classList.add('incorrect');
    });
    document.getElementById('a1-feedback').innerHTML =
      `<span style="color:#e53935;"><i class="fa-solid fa-circle-xmark"></i> Errou!</span>
       <div class="a1-explanation">${getExplicacao(currentTopic, currentQ, q.a[val], q.correct)}</div>`;
  }
}

function showGabarito(medalObj, t, q, qidx) {
  const labels = document.querySelectorAll('.a1-options label');
  labels.forEach((label, i) => {
    label.classList.remove('correct', 'incorrect');
    if (i === q.correct) label.classList.add('correct');
  });
  document.querySelectorAll('.a1-options input[type="radio"]').forEach(inp => inp.disabled = true);
  const fb = document.getElementById('a1-feedback');
  let medalTxt = '';
  if (medalObj.medalha !== null) {
    if (medalObj.medalha === 0)
      medalTxt = `🥇 <b>Ouro conquistada!</b>`;
    else if (medalObj.medalha === 1)
      medalTxt = `🥈 <b>Prata conquistada!</b>`;
    else
      medalTxt = `🥉 <b>Bronze conquistada!</b>`;
  }
  fb.innerHTML = `<span style="color:#43a047;"><i class="fa-solid fa-circle-check"></i> Correto!</span> ${medalTxt}`;
  document.getElementById('a1-next-btn').style.display = "inline-block";
}

function nextA1() {
  const t = a1Topics[currentTopic];
  if (currentQ < t.questions.length - 1) {
    currentQ++;
  } else if (currentTopic < a1Topics.length - 1) {
    currentTopic++;
    currentQ = 0;
  } else {
    showA1Result();
    return;
  }
  renderA1Exercise();
}

function getA1Progress() {
  let done = questoesTentativas.filter(q => q.answered).length;
  return `${done}/${totalQuestoes}`;
}

function showA1Result() {
  let ouro = questoesTentativas.filter(q => q.answered && q.medalha === 0).length;
  let percent = Math.round((ouro / totalQuestoes) * 100);
  let color = percent >= 60 ? "#43a047" : "#e53935";
  let msg = percent >= 60
    ? `<i class="fa-solid fa-crown"></i> Parabéns! Você concluiu o nível A1 com <b>${percent}%</b> de 🥇 (acertos de primeira tentativa).<br><br>
       O próximo nível está liberado, e você receberá um certificado no seu e-mail!`
    : `<i class="fa-solid fa-circle-xmark"></i> Você concluiu com <b>${percent}%</b> de OURO (acertos de primeira tentativa).<br><br>
       Você precisa repetir o nível para liberar o próximo.`;

  document.getElementById('a1-root').innerHTML = `
    <div class="a1-end-message" style="color:${color};">
      <div style="font-size:1.18em;">
        ${msg}
      </div>
    </div>
  `;
  renderMedalsStatus(true);

  if (percent >= 60 && window.currentUserNivel !== undefined) {
    fetch("/enviar_resultado", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({nivel: "A1", resultado: percent})
    });
  }
}

function medalIconHtml(idx) {
  if (idx === 0) return `<span class="a1-medal a1-medal-gold"><i class="fa-solid fa-medal"></i></span>`;
  if (idx === 1) return `<span class="a1-medal a1-medal-silver"><i class="fa-solid fa-medal"></i></span>`;
  return `<span class="a1-medal a1-medal-bronze"><i class="fa-solid fa-medal"></i></span>`;
}

function renderMedalsStatus(showAll = false) {
  let html = `<div class="a1-medals-row">`;
  let idx = 0;
  a1Topics.forEach((topic) => {
    topic.questions.forEach(() => {
      const m = questoesTentativas[idx];
      let medalStr = "";
      if (m.answered || showAll) {
        if (m.medalha !== null) {
          medalStr = medalIconHtml(m.medalha) + ` <span>${medalTypes[m.medalha].name}</span>`;
        } else {
          medalStr = `<span style="color:#aaa;">—</span>`;
        }
      }
      html += `<div class="a1-medal-item">
        <span style="font-weight:600;">${idx + 1}.</span> ${medalStr}
      </div>`;
      idx++;
    });
  });
  html += `</div>`;
  document.getElementById('a1-medals').innerHTML = html;
}

function getExplicacao(topicIdx, qIdx, resposta, correctIdx) {
  if (explicacoes[topicIdx] && explicacoes[topicIdx][qIdx]) {
    return explicacoes[topicIdx][qIdx];
  }
  return "Veja a explicação do tópico para entender melhor!";
}


// Sempre que ganhar uma medalha (após o fetch para /registrar_medalha), avise o menu:
function premiarMedalha(nivel, questao, medalha) {
    return fetch('/registrar_medalha', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({nivel, questao, medalha})
    })
    .then(res => res.json())
    .then(data => {
        if (data.medalha) {
            // Notifica o pai (menu principal)
            window.parent.postMessage({ medalhaGanha: true }, "*");
        }
    });
}


// Inicializa e mostra
inicializaQuestoes();
renderA1Exercise();
</script>
</body>
</html>