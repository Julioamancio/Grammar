<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Exercícios Interativos – Nível B1</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    .b1-ex-container {
      background: #fff;
      border-radius: 18px;
      max-width: 940px;
      margin: 26px auto 30px auto;
      box-shadow: 0 4px 32px #ff980015;
      padding: 32px 34px 25px 34px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .b1-title {
      font-size: 1.4em;
      color: #ff9800;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      margin-top: 0;
      justify-content: flex-start;
    }
    .b1-medals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 13px 18px;
      margin-bottom: 20px;
      align-items: center;
    }
    .b1-medal-item {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 1em;
      background: #f5f5f5;
      border-radius: 7px;
      padding: 5px 13px;
      min-width: 90px;
      border: 1px solid #e3e3e3;
      justify-content: center;
    }
    .b1-medal {
      font-size: 1.3em;
      padding-right: 2px;
      vertical-align: middle;
    }
    .b1-medal-gold { color: #ffb300; }
    .b1-medal-silver { color: #90caf9; }
    .b1-medal-bronze { color: #bcaaa4; }
    .b1-topic-title {
      font-size: 1.13em;
      color: #ff9800;
      font-weight: bold;
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .b1-question {
      font-size: 1.09em;
      margin-bottom: 13px;
      color: #1a237e;
    }
    .b1-options label {
      display: block;
      margin-bottom: 9px;
      background: #fff3e0;
      border-radius: 6px;
      padding: 9px 13px;
      cursor: pointer;
      transition: background 0.18s;
      font-size: 1.09em;
      border: 1px solid #ffe0b2;
    }
    .b1-options input[type="radio"] {
      margin-right: 8px;
    }
    .b1-options label.correct {
      background: #dcedc8;
      font-weight: 600;
    }
    .b1-options label.incorrect {
      background: #ffcdd2;
      font-weight: 600;
    }
    .b1-options input[disabled] + span,
    .b1-options input[disabled] {
      cursor: not-allowed;
    }
    .b1-feedback {
      margin-top: 7px;
      font-weight: bold;
      min-height: 18px;
    }
    .b1-explanation {
      margin-top: 5px;
      font-size: 0.98em;
      color: #1a237e;
      background: #e7f7e7;
      border-radius: 5px;
      padding: 6px 12px;
      margin-bottom: 5px;
      display: inline-block;
    }
    .b1-next-btn {
      background: #ff9800;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 22px;
      font-size: 1.06em;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.18s;
      display: none;
    }
    .b1-next-btn.active {
      display: inline-block;
    }
    .b1-progress {
      margin-top: 15px;
      color: #888;
      font-size: 0.98em;
    }
    @media (max-width: 1100px) {
      .b1-ex-container { max-width: 99vw; padding: 3vw 1vw; }
    }
    @media (max-width: 700px) {
      .b1-title { font-size: 1.1em; margin-top: 8px; }
      .b1-medals-row { flex-direction: column; gap: 7px; }
      .b1-medal-item { min-width: 0; width: 100%; }
      .b1-ex-container { padding: 2vw 2vw; }
    }
    .b1-end-message {
      text-align: center;
      padding: 25px 0;
      max-width: 540px;
      margin: 0 auto;
      background: #fff3e0;
      border-radius: 10px;
      box-shadow: 0 3px 12px #ff980030;
      margin-top: 24px;
    }
    .b1-navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .b1-back-button {
      text-decoration: none;
      color: #ff9800;
      display: flex;
      align-items: center;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="b1-ex-container">
  <div class="b1-navbar">
    <a href="/exercicios" class="b1-back-button">
      <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Voltar ao Menu
    </a>
  </div>
  <div class="b1-title">
    <i class="fa-solid fa-arrow-up-right-dots"></i>
    Exercícios Interativos – Nível B1
  </div>
  <div id="b1-medals"></div>
  <div id="b1-root"></div>
</div>
<script>
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
const b1Topics = [
  {
    icon: "fa-clock-check", color: "#ff9800", title: "Present perfect (just, already, yet, ever, never)", questions: [
      { q: "I ___ just ___ the dishes, so the kitchen is clean now.", a: ["have / washed", "has / washed", "have / washing"], correct: 0 },
      { q: "She ___ never ___ to Japan before this trip.", a: ["has / been", "have / been", "has / went"], correct: 0 }
    ]
  },
  {
    icon: "fa-clock-rotate-left", color: "#f57c00", title: "Present perfect vs. simple past", questions: [
      { q: "I ___ (visit) Paris three times in my life.", a: ["visited", "have visited", "have visit"], correct: 1 },
      { q: "She ___ (see) this movie last weekend.", a: ["has seen", "saw", "has saw"], correct: 1 }
    ]
  },
  {
    icon: "fa-code-branch", color: "#e65100", title: "First conditional (If + present, will...)", questions: [
      { q: "If it ___ tomorrow, we ___ stay at home.", a: ["rains / will", "will rain / will", "rains / would"], correct: 0 },
      { q: "She ___ help you if she ___ time.", a: ["will / has", "would / has", "will / have"], correct: 0 }
    ]
  },
  {
    icon: "fa-wand-magic-sparkles", color: "#3f51b5", title: "Modal verbs (must, might, may, should, have to...)", questions: [
      { q: "You ___ wear a seatbelt when driving; it's the law.", a: ["should", "must", "may"], correct: 1 },
      { q: "I ___ be late for the meeting, but I'm not sure yet.", a: ["must", "might", "have to"], correct: 1 }
    ]
  },
  {
    icon: "fa-user-group", color: "#673ab7", title: "Reflexive pronouns (myself, herself...)", questions: [
      { q: "She made that cake ___, without any help.", a: ["herself", "himself", "itself"], correct: 0 },
      { q: "They can take care of ___.", a: ["themself", "themselves", "them"], correct: 1 }
    ]
  },
  {
    icon: "fa-backward-step", color: "#9c27b0", title: "Used to (hábitos no passado)", questions: [
      { q: "I ___ a lot of coffee, but now I prefer tea.", a: ["used to drink", "use to drink", "used drink"], correct: 0 },
      { q: "He ___ in London before moving to Paris.", a: ["used lived", "was used to live", "used to live"], correct: 2 }
    ]
  },
  {
    icon: "fa-person-running", color: "#03a9f4", title: "Gerunds and infinitives (love doing / want to do)", questions: [
      { q: "I enjoy ___ foreign languages.", a: ["learn", "to learn", "learning"], correct: 2 },
      { q: "She wants ___ a doctor when she grows up.", a: ["becoming", "to become", "become"], correct: 1 }
    ]
  },
  {
    icon: "fa-comments", color: "#00bcd4", title: "Reported speech (basic statements)", questions: [
      { q: "He said, 'I am tired.' → He said that he ___ tired.", a: ["is", "was", "were"], correct: 1 },
      { q: "She said, 'I will call you.' → She said that she ___ call me.", a: ["will", "would", "is going to"], correct: 1 }
    ]
  },
  {
    icon: "fa-tags", color: "#009688", title: "Question tags", questions: [
      { q: "You like chocolate, ___?", a: ["don't you", "aren't you", "do you"], correct: 0 },
      { q: "They weren't at the party, ___?", a: ["weren't they", "were they", "didn't they"], correct: 1 }
    ]
  },
  {
    icon: "fa-sitemap", color: "#4caf50", title: "Relative clauses (who, which, that)", questions: [
      { q: "The woman ___ works at the bank is my neighbor.", a: ["which", "who", "whose"], correct: 1 },
      { q: "The book ___ I borrowed from you is very interesting.", a: ["who", "whom", "that"], correct: 2 }
    ]
  },
  {
    icon: "fa-rotate", color: "#cddc39", title: "Passive voice (present & past)", questions: [
      { q: "This building ___ by a famous architect in 1982.", a: ["was designed", "designed", "is designed"], correct: 0 },
      { q: "English ___ in many countries around the world.", a: ["speaks", "is spoken", "spoken"], correct: 1 }
    ]
  },
  {
    icon: "fa-code-branch", color: "#ffc107", title: "Second conditional", questions: [
      { q: "If I ___ rich, I ___ a big house by the sea.", a: ["am / would buy", "was / will buy", "were / would buy"], correct: 2 },
      { q: "What ___ if you ___ more free time?", a: ["would you do / had", "will you do / have", "did you do / had"], correct: 0 }
    ]
  },
  {
    icon: "fa-arrow-down-a-z", color: "#ff5722", title: "Adjective order (a big red car)", questions: [
      { q: "She bought a ___ jacket yesterday.", a: ["leather new black", "new black leather", "black new leather"], correct: 1 },
      { q: "They live in a ___ house in the countryside.", a: ["modern large beautiful", "beautiful large modern", "large beautiful modern"], correct: 2 }
    ]
  },
  {
    icon: "fa-equals", color: "#8d6e63", title: "Zero conditional", questions: [
      { q: "If you ___ water to 100°C, it ___.", a: ["heat / boils", "will heat / boils", "heat / will boil"], correct: 0 },
      { q: "Ice ___ if you ___ it to room temperature.", a: ["melts / expose", "will melt / exposed", "melts / exposed"], correct: 0 }
    ]
  },
  {
    icon: "fa-diagram-project", color: "#607d8b", title: "Phrasal verbs (look for, give up...)", questions: [
      { q: "I need to ___ this information online.", a: ["look for", "look at", "look after"], correct: 0 },
      { q: "Please don't ___ learning English. It takes time, but you'll improve.", a: ["give away", "give up", "give in"], correct: 1 }
    ]
  }
];
const explicacoesB1 = b1Topics.map(topic => topic.questions.map(() => [
  "Veja a explicação do tópico para entender melhor!"
]));
const medalTypes = [
  { name: "Ouro", icon: "fa-medal", class: "b1-medal-gold", emoji: "🥇" },
  { name: "Prata", icon: "fa-medal", class: "b1-medal-silver", emoji: "🥈" },
  { name: "Bronze", icon: "b1-medal-bronze", emoji: "🥉" }
];
const medalByAttempts = (n) => n === 1 ? 0 : n === 2 ? 1 : 2;
let currentTopic = 0, currentQ = 0;
let questoesTentativas = [];
let totalQuestoes = 0;
function embaralharTudo() {
  shuffle(b1Topics);
  b1Topics.forEach(topic => {
    shuffle(topic.questions);
    topic.questions.forEach(q => {
      const correctAnswer = q.a[q.correct];
      shuffle(q.a);
      q.correct = q.a.indexOf(correctAnswer);
    });
  });
}
function inicializaQuestoes() {
  embaralharTudo();
  questoesTentativas = [];
  b1Topics.forEach(topic => {
    topic.questions.forEach(() => {
      questoesTentativas.push({ tentativas: 0, medalha: null, answered: false });
    });
  });
  totalQuestoes = questoesTentativas.length;
}
function getQuestaoIdx(topicIdx, qIdx) {
  let idx = 0;
  for (let t = 0; t < topicIdx; t++) {
    idx += b1Topics[t].questions.length;
  }
  return idx + qIdx;
}
function renderB1Exercise() {
  renderMedalsStatus();
  const t = b1Topics[currentTopic];
  const q = t.questions[currentQ];
  const qidx = getQuestaoIdx(currentTopic, currentQ);
  const medalObj = questoesTentativas[qidx];
  let html = `
    <div>
      <div class="b1-topic-title">
        <i class="fa-solid ${t.icon}" style="color:${t.color}"></i> ${t.title}
      </div>
      <div class="b1-question">${q.q}</div>
      <form class="b1-options" id="b1-options">
        ${q.a.map((opt, i) => `
          <label>
            <input type="radio" name="b1" value="${i}" ${medalObj.answered ? "disabled" : ""}> ${opt}
          </label>
        `).join('')}
      </form>
      <div class="b1-feedback" id="b1-feedback"></div>
      <button class="b1-next-btn" id="b1-next-btn" style="display:none;">Próxima</button>
      <div class="b1-progress">
        Progresso: <b>${getB1Progress()}</b>
      </div>
    </div>
  `;
  document.getElementById('b1-root').innerHTML = html;
  if (medalObj.answered) {
    showGabarito(medalObj, t, q, qidx);
  }
  document.getElementById('b1-options').onclick = function(e) {
    if (e.target.name === "b1" && !medalObj.answered) {
      checkB1(e.target.value);
    }
  };
  document.getElementById('b1-next-btn').onclick = nextB1;
}
function checkB1(val) {
  val = +val;
  const t = b1Topics[currentTopic];
  const q = t.questions[currentQ];
  const qidx = getQuestaoIdx(currentTopic, currentQ);
  const medalObj = questoesTentativas[qidx];
  medalObj.tentativas++;
  const radios = document.querySelectorAll('.b1-options input[type="radio"]');
  if (val === q.correct) {
    medalObj.answered = true;
    medalObj.medalha = medalByAttempts(medalObj.tentativas);
    showGabarito(medalObj, t, q, qidx);
    renderMedalsStatus();
  } else {
    radios.forEach(inp => inp.checked = false);
    const labels = document.querySelectorAll('.b1-options label');
    labels.forEach((label, i) => {
      label.classList.remove('correct', 'incorrect');
      if (i === val) label.classList.add('incorrect');
    });
    document.getElementById('b1-feedback').innerHTML =
      `<span style="color:#e53935;"><i class="fa-solid fa-circle-xmark"></i> Errou!</span>
       <div class="b1-explanation">${getExplicacaoB1(currentTopic, currentQ)}</div>`;
  }
}
function showGabarito(medalObj, t, q, qidx) {
  const labels = document.querySelectorAll('.b1-options label');
  labels.forEach((label, i) => {
    label.classList.remove('correct', 'incorrect');
    if (i === q.correct) label.classList.add('correct');
  });
  document.querySelectorAll('.b1-options input[type="radio"]').forEach(inp => inp.disabled = true);
  const fb = document.getElementById('b1-feedback');
  let medalTxt = '';
  if (medalObj.medalha !== null) {
    if (medalObj.medalha === 0)
      medalTxt = `🥇 <b>Ouro conquistada!</b>`;
    else if (medalObj.medalha === 1)
      medalTxt = `🥈 <b>Prata conquistada!</b>`;
    else
      medalTxt = `🥉 <b>Bronze conquistada!</b>`;
  }
  fb.innerHTML = `<span style="color:#43a047;"><i class="fa-solid fa-circle-check"></i> Correto!</span> ${medalTxt}`;
  document.getElementById('b1-next-btn').style.display = "inline-block";
}
function nextB1() {
  const t = b1Topics[currentTopic];
  if (currentQ < t.questions.length - 1) {
    currentQ++;
  } else if (currentTopic < b1Topics.length - 1) {
    currentTopic++;
    currentQ = 0;
  } else {
    showB1Result();
    return;
  }
  renderB1Exercise();
}
function getB1Progress() {
  let done = questoesTentativas.filter(q => q.answered).length;
  return `${done}/${totalQuestoes}`;
}
function showB1Result() {
  let ouro = questoesTentativas.filter(q => q.answered && q.medalha === 0).length;
  let percent = Math.round((ouro / totalQuestoes) * 100);
  let color = percent >= 60 ? "#43a047" : "#e53935";
  let msg = percent >= 60
    ? `<i class="fa-solid fa-crown"></i> Parabéns! Você concluiu o nível B1 com <b>${percent}%</b> de OURO (acertos de primeira tentativa).<br><br>
       O próximo nível está liberado, e você receberá um certificado no seu e-mail!`
    : `<i class="fa-solid fa-circle-xmark"></i> Você concluiu com <b>${percent}%</b> de OURO (acertos de primeira tentativa).<br><br>
       Você precisa repetir o nível para liberar o próximo.`;
  document.getElementById('b1-root').innerHTML = `
    <div class="b1-end-message" style="color:${color};">
      <div style="font-size:1.18em;">
        ${msg}
      </div>
    </div>
  `;
  renderMedalsStatus(true);
  if (percent >= 60 && window.currentUserNivel !== undefined) {
    fetch("/enviar_resultado", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({nivel: "B1", resultado: percent})
    });
  }
}
function renderMedalsStatus(showAll = false) {
  let html = `<div class="b1-medals-row">`;
  let idx = 0;
  b1Topics.forEach((topic) => {
    topic.questions.forEach(() => {
      const m = questoesTentativas[idx];
      let medalStr = "";
      if (m.answered || showAll) {
        if (m.medalha !== null) {
          medalStr = medalIconHtml(m.medalha) + ` <span>${medalTypes[m.medalha].name}</span>`;
        } else {
          medalStr = `<span style="color:#aaa;">—</span>`;
        }
      }
      html += `<div class="b1-medal-item">
        <span style="font-weight:600;">${idx + 1}.</span> ${medalStr}
      </div>`;
      idx++;
    });
  });
  html += `</div>`;
  document.getElementById('b1-medals').innerHTML = html;
}
function getExplicacaoB1(topicIdx, qIdx) {
  if (explicacoesB1[topicIdx] && explicacoesB1[topicIdx][qIdx]) {
    const arr = explicacoesB1[topicIdx][qIdx];
    if (arr) {
      return arr[0] || "Confira a explicação do tópico.";
    }
  }
  return "Confira a explicação do tópico.";
}
function medalIconHtml(idx) {
  if (idx === 0) return `<span class="b1-medal b1-medal-gold"><i class="fa-solid fa-medal"></i></span>`;
  if (idx === 1) return `<span class="b1-medal b1-medal-silver"><i class="fa-solid fa-medal"></i></span>`;
  return `<span class="b1-medal b1-medal-bronze"><i class="fa-solid fa-medal"></i></span>`;
}
inicializaQuestoes();
renderB1Exercise();
</script>
</body>
</html>